/**
 * -----------------------------------------------------------------------------------------
 * INTERSEL - 4 cité d'Hauteville - 75010 PARIS
 * RCS PARIS 488 379 660 - NAF 721Z
 *
 * File : blapy2.js
 * Blapy2 runtime for browser usage, including Blapy V1 compatibility.
 *
 * -----------------------------------------------------------------------------------------
 * @copyright Intersel 2015-2025
 * @fileoverview Blapy2 runtime for browser usage, including Blapy V1 compatibility.
 * @see {@link https://github.com/intersel/blapy2}
 * @author Corentin NELHOMME - corentin.nelhomme@intersel.fr
 * @version 1.0.1
 * @license DonationWare - see https://github.com/intersel/blapy2/blob/master/LICENSE
 * -----------------------------------------------------------------------------------------
 */
(function(){"use strict";class Logger{constructor(t={}){const{debug:e=!1,logLevel:a=1,alertError:r=!1}=t;this.debug=e,this.logLevel=a,this.alertError=r}error(t,e="blapy"){this.log(t,1,e)}warn(t,e="blapy"){this.log(t,2,e)}info(t,e="blapy"){this.log(t,3,e)}log(t,e=3,a="blapy"){if(!(e>this.logLevel)&&(!(e>=2)||this.debug)&&("undefined"!=typeof window&&window.console?.log||"undefined"!=typeof console))switch(e){case 1:console.error(`[Blapy2] ${t} from ${a}`),this.alertError&&alert(`[Blapy2 Error] ${t} from ${a}`);break;case 2:console.warn(`[Blapy2] ${t} from ${a}`);break;default:console.log(`[Blapy2] ${t} from ${a}`)}}}class Utils{atou(t){return decodeURIComponent(atob(t))}utoa(t){return btoa(String.fromCharCode(...(new TextEncoder).encode(t)))}}class TemplateManager{constructor(t,e,a){this.logger=t,this.ajaxService=e,this.utils=a,this.templates=new Map}async setBlapyContainerJsonTemplate(t,e,a=!1){this.logger.info("setBlapyContainerJsonTemplate","template manager"),t.setAttribute("data-blapy-update-rule","local");let r=Array.from(t.children).filter(t=>t.hasAttribute("data-blapy-container-tpl")),n=t.innerHTML;if(0===r.length){try{const t=document.createElement("div");t.innerHTML=n.trim();const e=t.firstElementChild;e&&"XMP"===e.tagName&&(n=e.innerHTML)}catch(i){this.logger.error("htmlTplContent from "+t.id+" is not html template...?\n"+n)}if(""==n.replace(/(<!--.*?-->)|(<!--[\S\s]+?-->)|(<!--[\S\s]*?$)/g,"").replace(/\s{2,}/g," ").replace(/\t/g," ").replace(/(\r\n|\n|\r)/g,"").replace(/(\/\*[^*]*\*\/)|(\/\/[^*]*)/g,"").trim()){let a=t.getAttribute("data-blapy-template-file"),r="1"==t.getAttribute("data-blapy-noblapydata")?"":"blapycall=1&blapyaction=loadTpl&blapyobjectid="+t.getAttribute("id");if(a&&!this.templates.has(a)){n=await this.ajaxService.get(a,{params:r}),n=n.replace(/<!--(.*?)-->/gm,"").replaceAll("\n\n","\n").replaceAll("\t\t","\t");const i=document.createElement("div");i.innerHTML=n.trim(),i.firstElementChild&&"xmp"===i.firstElementChild.tagName.toLowerCase()||(n='<xmp style="display:none" data-blapy-container-tpl="true">'+n+"</xmp>"),t.innerHTML=n,this.templates.set(a,n),this._initializeJsonBlock(t,!1,e)}else a&&this.templates.has(a)?(this.logger.info("The templates use cache memory"),t.innerHTML=this.templates.get(a),this._initializeJsonBlock(t,!1,e)):this._initializeJsonBlock(t,!1,e)}else{"xmp"!==n.replace(/{{(.*?)}}/gm,"").split("script").join("scriptblapy").split("img").join("imgblapy").tagName?(n='<xmp style="display:none" data-blapy-container-tpl="true">'+n+"</xmp>",t.innerHTML=n):t.innerHTML=n,this._initializeJsonBlock(t,!1,e)}}else a&&this._initializeJsonBlock(t,!0,e)}getObjects(t,e,a){let r=[];for(let n in t)t.hasOwnProperty(n)&&("object"==typeof t[n]?r=r.concat(this.getObjects(t[n],e,a)):(n==e&&t[n]==a||n==e&&""==a||t[n]==a&&""==e&&-1==r.lastIndexOf(t))&&r.push(t));return r}_initializeJsonBlock(t,e=!1,a=a){this.logger.info("_initializeJsonBlock","template manager"),t.getAttribute("data-blapy-container-name"),t.getAttribute("data-blapy-template-init");let r=null;if(r="undefined"==typeof JSON5?JSON:JSON5,!e&&t.getAttribute("data-blapy-updateblock-ondisplay")&&"done"!==t.getAttribute("data-blapy-appear"))return;let n=t.getAttribute("data-blapy-template-init");if(n){let e=t.getAttribute("data-blapy-template-init-params");e=null!=e?r.parse(e):{},"0"!==t.getAttribute("data-blapy-template-init-purejson")&&(e={...e,embeddingBlockId:t.getAttribute("data-blapy-container-name")});let i=t.getAttribute("data-blapy-noblapydata");null==i&&(i="0");let o=t.getAttribute("data-blapy-template-init-method");null==o&&(o="GET"),a.myFSM.trigger("postData",{aUrl:n,params:e,method:o,noBlapyData:i})}t.id&&a.trigger("Blapy_templateReady",{detail:t})}async processJsonUpdate(t,e,a,r,n){try{const i=await this._extractAndParseJsonData(t,a,r);e.getAttribute("data-blapy-container-name");if(!i)return;const o=this._applyDataTransformations(i,e,r),l=this._getTemplate(e);if(!l)return;const s=this._generateHtml(o,l,e);this._injectFinalHtml(s,e,n,l)}catch(i){this.logger.error(`Erreur dans processJsonUpdate: ${i.message}`,"templateManager")}}async _extractAndParseJsonData(t,e,a){this.logger.info("_extractAndParseJsonData","templateManager");let r=t?this.utils.atou($(t).html()):$(e).html();r=r.trim().replace(/(\r\n|\n|\r)/g,"");try{const t=a.parse(r);return this._extractBlapyData(t,e)}catch(n){this.logger.warn("Premier parsing échoué, tentative d'extraction HTML","templateManager");try{r=$(r).html();const t=r.replace(/(\r\n|\n|\r)/g,""),n=a.parse(t);return this._extractBlapyData(n,e)}catch(i){throw this.logger.error("Parsing impossible même après extraction HTML"+r,"templateManager"),new Error("Parsing JSON impossible")}}}_extractBlapyData(t,e=null){if(this.logger.info("_extractBlapyData","templateManager"),t["blapy-data"]&&t["blapy-container-name"]){const a=e?.getAttribute?.("data-blapy-container-name");return a&&t["blapy-container-name"]!=a?(this.logger.warn("blapy-data set: "+JSON.stringify(t)+"\n but not match with containerName "+a),null):t["blapy-data"]}return t}_applyDataTransformations(t,e,a){this.logger.info("_applyDataTransformations","templateManager");let r=t;return r=this._applyInitFromProperty(r,e),r=this._applyInitSearch(r,e),r=this._applyProcessDataFunctions(r,e,a),this._addBlapyIndices(r)}_applyInitFromProperty(t,e){if(this.logger.info("_applyInitFromProperty","templateManager"),!e.hasAttribute("data-blapy-template-init-fromproperty")||""===e.getAttribute("data-blapy-template-init-fromproperty"))return t;try{this.logger.info("Apply data-blapy-template-init-fromproperty: "+e.getAttribute("data-blapy-template-init-fromproperty"));const a=e.getAttribute("data-blapy-template-init-fromproperty");if(a){return a.split(".").reduce((t,e)=>void 0!==t[e]?t[e]:t,t)}return t}catch(a){return this.logger.error("init-search or init-property does not work well on json data of container: "+e.id,"templateManager"),t}}_applyInitSearch(t,e){this.logger.info("_applyInitSearch","templateMnager");const a=e.getAttribute("data-blapy-template-init-search");if(!a||""===a)return t;try{this.logger.info("Apply data-blapy-template-init-search: "+e.getAttribute("data-blapy-template-init-search"));JSON.stringify(t);return t=(t=a.split(",").map(t=>t.split("==")).reduce((e,a)=>{const r=this.getObjects(t,a[0],a[1]);return r.length?e.concat(r):e},[])).filter((e,a)=>a===t.findIndex(t=>JSON.stringify(t)===JSON.stringify(e)))}catch(r){return this.logger.error("init-search or init-property does not work well on json data of container: "+e.id,"templateManager"),t}}_applyProcessDataFunctions(jsonDataObj,myContainer,jsonFeatures){if(this.logger.info("_applyProcessDataFunctions","templateManager"),!myContainer.hasAttribute("data-blapy-template-init-processdata")||""===myContainer.getAttribute("data-blapy-template-init-processdata"))return jsonDataObj;let aJsonDataFunction=myContainer.getAttribute("data-blapy-template-init-processdata");return aJsonDataFunction&&(this.logger.info("Apply data-blapy-template-init-processdata: "+aJsonDataFunction),aJsonDataFunction.split(",").forEach(aFunctionName=>{let previousJsonDataObj=jsonFeatures;eval("if (typeof "+aFunctionName+' === "function")    jsonDataObj='+aFunctionName+'(jsonDataObj);else     this.logger.error("'+aFunctionName+" does not exist :(! Have a look on the : data-blapy-template-init-processdata of container "+myContainer.id+'", "templateManager");'),"object"!=typeof jsonDataObj&&(this.logger.error("returned Json Data was not a json structure :(! Perhaps it is due to the processing of this function on them: "+aJsonDataFunction,"templateManager"),jsonDataObj=previousJsonDataObj)})),jsonDataObj}_addBlapyIndices(t){if(t.length)for(let e=0;e<t.length;e++)null==t[e].blapyIndex&&(t[e].blapyIndex=e+1),0==e&&(t[e].blapyFirst=!0),e==t.length-1&&(t[e].blapyLast=!0);else t.blapyIndex=0;return t}_getTemplate(t){let e="",a=t.querySelectorAll("[data-blapy-container-tpl]"),r="",n=t.getAttribute("data-blapy-template-default-id");if(null!=n&&""!=n){let a=`:scope > [data-blapy-container-tpl][data-blapy-container-tpl-id='${n}']`;e=t.querySelectorAll(a),0==e.length&&this.logger.error("The json template of id "+n+" was not found for the block "+t.getAttribute("data-blapy-container-name")+"!","templateManager")}return 0==e.length&&(e=a),0==e.length?(r="",this.logger.error("can not find any json template for the block: "+t.getAttribute("data-blapy-container-name"),"templateManager"),null):(r=e[0].innerHTML,r.length<3?(this.logger.error("Template is void... ? "+t.getAttribute("data-blapy-container-name"),"templateManager"),null):{content:r,allTemplates:a})}_generateHtml(t,e,a){let r=this._prepareTemplateContent(e.content),n="",i=!1;const o=JSON.stringify(t);if("undefined"!=typeof Mustache){let e="{{",o="}}",l="";a.hasAttribute("data-blapy-template-mustache-delimiterStart")&&""!==a.getAttribute("data-blapy-template-mustache-delimiterStart")&&(e=a.getAttribute("data-blapy-template-mustache-delimiterStart"),o=a.getAttribute("data-blapy-template-mustache-delimiterEnd"),l="{{="+e+" "+o+"=}}"),(""!=l||r.includes("{{"))&&(n=Mustache.render(l+e+"#."+o+r+e+"/."+o,t),i=!0)}return i||"undefined"==typeof json2html||(n=json2html.transform(o,{tag:"void",html:r}),n=n.replace(/<.?void>/g,""),i=!0),i?n:(this.logger.error("no json parser loaded... need to include json2html or Mustache library! ","templateManager"),alert('no json parser loaded... need to include "json2html" or "Mustache" library!'),"")}_prepareTemplateContent(t){return t.replace(/\|xmp/gi,"xmp").replace(/\|\/xmp/gi,"/xmp").replace(/blapyScriptJS/gi,"script")}_injectFinalHtml(t,e,a,r){let n=t;if(e.hasAttribute("data-blapy-template-header")&&(this.logger.info("Apply data-blapy-template-header"),n=e.getAttribute("data-blapy-template-header")+n),e.hasAttribute("data-blapy-template-footer")&&(this.logger.info("Apply data-blapy-template-footer"),n+=e.getAttribute("data-blapy-template-footer")),e.hasAttribute("data-blapy-template-wrap")){this.logger.info("Apply data-blapy-template-wrap");const t=e.getAttribute("data-blapy-template-wrap"),a=document.createElement("div");a.innerHTML=t,a.firstElementChild.innerHTML=n,n=a.firstElementChild.outerHTML}let i="";r&&r.allTemplates&&r.allTemplates.forEach(t=>{i+=t.outerHTML}),e.innerHTML=i+n;e.querySelectorAll("script").forEach(t=>{const e=document.createElement("script");t.src?e.src=t.src:e.textContent=t.textContent,t.parentNode.replaceChild(e,t)}),setTimeout(()=>{const t=e.querySelectorAll('[data-blapy-update="json"]');if(t.length>0){a.myFSM.trigger("blapyJsonTemplatesToSet");let e=this;!async function(){for(const r of t)await e.setBlapyContainerJsonTemplate(r,a);a.myFSM.trigger("blapyJsonTemplatesIsSet")}()}else a.myFSM.trigger("blapyJsonTemplatesIsSet")},0)}}class Router{constructor(t,e,a={}){this.logger=t,this.blapy=e,this.opts={enableRouter:!1,root:"/",hash:!1,strategy:"ONE",noMatchWarning:!1,linksSelector:"[data-blapy-link]",...a},this.router=null,this.isInitialized=!1}init(){return this.logger.info("Router initialization starting...","router"),this.opts.enableRouter?"function"!=typeof Navigo?(this.logger.error("Navigo is not loaded... can not continue","router"),alert("Navigo is not loaded... can not continue"),!1):(this._initNavigoRouter(),!0):(this.logger.info("Router disabled, using standard event handlers","router"),this._initStandardHandlers(),!0)}_initStandardHandlers(){this.logger.info("Initializing standard event handlers (no routing)","router");const t=this.blapy.container;t.addEventListener("click",t=>{const e=t.target.closest("a[data-blapy-link]");if(!e)return;const a=e.getAttribute("data-blapy-active-blapyid");if(a&&a!==this.blapy.myUIObjectID)return;t.preventDefault();const r=this._extractLinkParams(e),n=e.getAttribute("data-blapy-embedding-blockid");n&&(r.embeddingBlockId=n),this.logger.info(`Standard link clicked: ${e.href}`,"router"),this.blapy.myFSM.trigger("postData",{aUrl:this._extractUrl(e.href),params:r,method:e.getAttribute("method")||"GET",aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})}),t.addEventListener("submit",t=>{const e=t.target;if(!e.matches("form[data-blapy-link]"))return;const a=e.getAttribute("data-blapy-active-blapyid");if(a&&a!==this.blapy.myUIObjectID)return;t.preventDefault(),this.logger.info(`Form submitted: ${e.action}`,"router");const r=this._extractFormData(e,t),n=e.getAttribute("data-blapy-embedding-blockid");n&&(r.embeddingBlockId=n),this.blapy.myFSM.trigger("postData",{aUrl:this._extractUrl(e.action),params:r,method:e.getAttribute("method")||"POST",aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})})}_initNavigoRouter(){this.logger.info("Initializing simple router (manual history management)","router"),this._interceptBlapyLinks(),window.addEventListener("popstate",t=>{this.logger.info("Popstate event detected","router"),this.blapy.myFSM.trigger("loadUrl",{aUrl:window.location.pathname+window.location.search,params:{},aObjectId:this.blapy.myUIObjectID})}),this.isInitialized=!0,this.logger.info("Simple router initialized","router")}_handleBlapyLink(t,e="GET"){const a=t.url||t.route.path;this.logger.info(`Navigo route matched: ${e} ${a}`,"router");const r=document.querySelector(`[href="${a}"], [action="${a}"]`);if(r){const t=r.getAttribute("data-blapy-active-blapyid");if(t&&t!==this.blapy.myUIObjectID)return void this.logger.info(`Route filtered - not for this Blapy instance: ${t}`,"router")}const n=this._extractEmbeddingBlockId(a),i={...t.params,...t.data||{}};n&&(i.embeddingBlockId=n);const o=this._cleanBlapyUrl(a);"GET"===e?this.blapy.myFSM.trigger("loadUrl",{aUrl:o,params:this._filterAttributes(i),aObjectId:this.blapy.myUIObjectID,noBlapyData:r?.getAttribute("data-blapy-noblapydata")}):this.blapy.myFSM.trigger("postData",{aUrl:o,params:this._filterAttributes(i),aObjectId:this.blapy.myUIObjectID,method:e.toLowerCase(),noBlapyData:r?.getAttribute("data-blapy-noblapydata")})}_extractEmbeddingBlockId(t){const e=/#blapylink#(.*)/i.exec(t);return e&&e[1]?e[1]:""}_cleanBlapyUrl(t){return t.replace(/#blapylink.*$/,"")}_filterAttributes(t){const e={};for(const[a,r]of Object.entries(t))"function"!=typeof r&&"object"!=typeof r&&(e[a]=r);return e}_extractLinkParams(t){const e=t.getAttribute("data-blapy-params");if(!e)return{};try{return("undefined"!=typeof JSON5?JSON5:JSON).parse(e)}catch(a){return this.logger.warn(`Failed to parse link params: ${e}`,"router"),{}}}_extractFormData(t,e){const a=new FormData(t),r={};for(const[n,i]of a.entries())r[n]=i;if(e.submitter){const t=e.submitter;t.name&&(r[t.name]=t.value||"")}else if(e.originalEvent&&e.originalEvent.submitter){const t=e.originalEvent.submitter;t.name&&(r[t.name]=t.value||"")}return r}_extractUrl(t){if(!t)return window.location.href;const e=t.indexOf("#");return-1!==e?t.substring(0,e):t}navigate(t,e={}){if(!this.isInitialized||!this.router)return void this.logger.warn("Router not initialized, cannot navigate","router");this.logger.info(`Navigating to: ${t}`,"router");const a={title:e.title,stateObj:e.stateObj,historyAPIMethod:e.historyAPIMethod||"pushState",updateBrowserURL:!1!==e.updateBrowserURL,callHandler:!1!==e.callHandler,callHooks:!1!==e.callHooks,updateState:!1!==e.updateState,force:e.force||!1};this.router.navigate(t,a)}resolve(t){return this.isInitialized&&this.router?this.router.resolve(t):(this.logger.warn("Router not initialized, cannot resolve","router"),!1)}destroy(){this.router&&(this.router.destroy(),this.router=null,this.isInitialized=!1,this.logger.info("Router destroyed","router"))}_interceptBlapyLinks(){this.blapy.container.addEventListener("click",t=>{const e=t.target.closest("a[data-blapy-link]");if(!e)return;const a=e.getAttribute("href");if(!a||!a.includes("#blapylink"))return;const r=e.getAttribute("data-blapy-active-blapyid");if(r&&r!==this.blapy.myUIObjectID)return;t.preventDefault();const n=this._extractLinkParams(e),i=this._extractEmbeddingBlockId(a);i&&(n.embeddingBlockId=i);const o=this._cleanBlapyUrl(a);window.history.pushState({blapy:!0},"",o),this.logger.info(`Navigating to: ${o}`,"router"),this.blapy.myFSM.trigger("loadUrl",{aUrl:o,params:this._filterAttributes(n),aObjectId:this.blapy.myUIObjectID,noBlapyData:e.getAttribute("data-blapy-noblapydata")})})}}class BlapyBlock{constructor(t,e){this.logger=t,this.templateManager=e,this.blocks=new Map,this.intervalsSet=new Map,this.blapy=null,this.logger.info("BlapyBlocks initialized","blocks")}setBlapyInstance(t){this.blapy=t}initializeBlocks(t){this.logger.info("Initializing Blapy blocks","blocks");t.querySelectorAll('[data-blapy-container="true"]').forEach(t=>{const e=t.getAttribute("data-blapy-container-name");e?(this.blocks.set(e,{element:t,name:e}),this.logger.info(`Block registered: ${e}`,"blocks")):this.logger.warn("Block without container name found","blocks")})}setBlapyUpdateIntervals(){this.logger.info("Setting up update intervals","blocks"),this.intervalsSet.forEach(t=>clearInterval(t)),this.intervalsSet.clear();const t=this.blapy.myUIObject.querySelectorAll("[data-blapy-updateblock-time]");let e=0;t.forEach(t=>{const a=parseInt(t.getAttribute("data-blapy-updateblock-time")),r=t.getAttribute("data-blapy-href"),n=t.getAttribute("data-blapy-container-name"),i=t.getAttribute("data-blapy-noblapydata");if(a&&r){this.logger.info(`Setting interval for ${n}: ${a}ms`,"blocks");const t=r+"?blapyContainerName="+n,o=setInterval(()=>{this.logger.info(`Interval triggered for ${n}`,"blocks"),this.blapy.myFSM.trigger("loadUrl",{aUrl:t,params:{},aObjectId:this.blapy.myUIObjectID,noBlapyData:i})},a);this.intervalsSet.set(e,o),e++,this.logger.info(`✅ Interval set for ${n}: ${a}ms (index: ${e-1})`,"blocks")}else a||this.logger.warn(`Block ${n} has no update time`,"blocks"),r||this.logger.warn(`Block ${n} has no href`,"blocks")}),this.logger.info(`Total intervals set: ${this.intervalsSet.size}`,"blocks")}}class AjaxService{constructor(t){this.logger=t}async request(t,e={}){if(!t)throw new Error("URL is required");const{method:a="GET",body:r=null,headers:n={},params:i=null,timeout:o=3e4}=e;return new Promise((e,l)=>{const s=new XMLHttpRequest;let p=t;if("GET"===a.toUpperCase()&&i){const e=new URLSearchParams(i);p+=(t.includes("?")?"&":"?")+e.toString()}s.open(a.toUpperCase(),p,!0),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),Object.entries(n).forEach(([t,e])=>{s.setRequestHeader(t,e)}),s.timeout=o,s.onload=()=>{if(s.status>=200&&s.status<300)try{if(s.getResponseHeader("content-type")?.includes("application/json")){const t=JSON.parse(s.responseText);this.logger?.info(`AJAX Success (JSON): ${a} ${p}`,{status:s.status,dataKeys:Object.keys(t)}),e(t)}else this.logger?.info(`AJAX Success (Text): ${a} ${p}`,{status:s.status,responseLength:s.responseText.length}),e(s.responseText)}catch(t){this.logger?.info(`AJAX Success (Raw): ${a} ${p}`,{status:s.status,parseError:t.message}),e(s.responseText)}else{const t=new Error(`HTTP ${s.status}: ${s.statusText}`);this.logger?.error(`AJAX Error: ${a} ${p}`,{status:s.status,statusText:s.statusText,response:s.responseText}),l(t)}},s.onerror=()=>{const t=new Error("Network error occurred");this.logger?.error(`AJAX Network Error: ${a} ${p}`),l(t)},s.ontimeout=()=>{const t=new Error(`Request timeout after ${o}ms`);this.logger?.error(`AJAX Timeout: ${a} ${p}`),l(t)},"GET"!==a.toUpperCase()&&r?this._sendWithBody(s,r):s.send()})}_sendWithBody(t,e){if(e instanceof FormData)t.send(e);else if("string"==typeof e)t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(e);else if(e&&"object"==typeof e){const a=new URLSearchParams;Object.entries(e).forEach(([t,e])=>{null!=e&&a.append(t,e.toString())}),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(a.toString())}else t.send()}async get(t,e={}){return this.request(t,{...e,method:"GET"})}async post(t,e,a={}){return this.request(t,{...a,method:"POST",body:e})}}class Blapy{constructor(t,e={}){if(!t)throw new Error("Blapy needs a valid DOM element");if("string"==typeof t){const e=document.querySelector(t);if(!e)throw new Error(`Element not found: ${t}`);t=e}if(!(t instanceof HTMLElement))throw new Error("Blapy needs a valid DOM element");if(!t.id)throw new Error("Blapy needs an element with an ID");this.container=t,this.defaults={debug:!1,logLevel:1,alertError:!1,enableRouter:!1,routerRoot:"/",routerHash:!1,pageLoadedFunction:null,pageReadyFunction:null,beforePageLoad:null,beforeContentChange:null,afterContentChange:null,afterPageChange:null,onErrorOnPageChange:null,doCustomChange:null,fsmExtension:null,LogLevelIfsm:1,debugIfsm:!1,websocketOptions:{}},this.opts={...this.defaults,...e},this.optsIfsm=this.opts,this.optsIfsm.debug=this.opts.debugIfsm,this.optsIfsm.logLevel=this.opts.LogLevelIfsm,"undefined"!=typeof Blapymotion&&(this.animation=new Blapymotion),this.myUIObject=this.container,this.myUIObjectID=this.container.id,this.utils=new Utils,this.logger=new Logger(this.opts),this.ajaxService=new AjaxService(this.logger),this.templateManager=new TemplateManager(this.logger,this.ajaxService,this.utils),this.router=new Router(this.logger,this,{enableRouter:this.opts.enableRouter,root:this.opts.routerRoot,hash:this.opts.routerHash,strategy:"ONE",noMatchWarning:!1,linksSelector:"[data-blapy-link]"}),this.blapyBlocks=new BlapyBlock(this.logger,this.templateManager,this.ajaxService),this.blapyBlocks.initializeBlocks(this.container),this.blapyBlocks.setBlapyInstance(this),this.myFSM=null,this.opts.theBlapy=this,"undefined"!=typeof BlapySocket&&Object.keys(this.opts.websocketOptions).length>0&&(this.websocket=new BlapySocket({...this.opts.websocketOptions},this)),this.logger.info(`Blapy instance (#${this.myUIObjectID}) created`,"Blapy2 constructor")}async initApplication(){this.logger.info("InitApplication","core");try{const t={PageLoaded:{enterState:{init_function:function(){this.opts.theBlapy.myFSM=this,this.opts.theBlapy.logger.info("Page loaded","fsm"),this.opts.theBlapy.blapyBlocks.setBlapyUpdateIntervals(),this.opts.pageLoadedFunction&&this.opts.pageLoadedFunction(),this.opts.theBlapy.trigger("Blapy_PageLoaded")},next_state:"PreparePage"}},PreparePage:{enterState:{init_function:function(){},propagate_event:"setBlapyUrl"},setBlapyUrl:{init_function:function(){this.opts.theBlapy.setBlapyURL()},next_state:"PreparePage_setBlapyJsonTemplates"}},PreparePage_setBlapyJsonTemplates:{enterState:{init_function:function(){this.opts.theBlapy.setBlapyJsonTemplates()},next_state:"PreparePage_setBlapyUpdateOnDisplay"}},PreparePage_setBlapyUpdateOnDisplay:{blapyJsonTemplatesIsSet:{init_function:function(){this.opts.theBlapy.setBlapyUpdateOnDisplay()},next_state:"PageReady"},reloadBlock:"loadUrl",updateBlock:"loadUrl",postData:"loadUrl",loadUrl:{how_process_event:{delay:50,preventcancel:!0},propagate_event:!0}},PageReady:{enterState:{init_function:function(){this.opts.pageReadyFunction&&this.opts.pageReadyFunction(),this.opts.theBlapy.trigger("Blapy_PageReady")}},loadUrl:{init_function:function(t,e,a){a.method="GET",this.trigger("postData",a)}},postData:{init_function:function(t,e,a){this.opts.beforePageLoad&&this.opts.beforePageLoad(a),this.opts.theBlapy.trigger("Blapy_beforePageLoad",a)},out_function:function(t,e,a){let r=a.aUrl,n=a.aObjectId?a.aObjectId:e.currentTarget.id;null==n&&void 0!==e.currentTarget.attr&&(n=e.currentTarget[0].id),a.params||(a.params={});let i=JSON.parse(JSON.stringify(a.params));i?i.blapyaction||(i.blapyaction="update"):i={blapyaction:"update"},"embeddingBlockId"in i&&!i.embeddingBlockId&&this.opts.theBlapy.logger.error("[postData on "+this.myUIObjectID+"] embeddingBlockId has been set but is undefined! must be an error...");let o=i.embeddingBlockId;if(o&&i.templateId){this.opts.theBlapy.myUIObject.querySelectorAll("[data-blapy-container-name='"+o+"']").forEach(t=>{t.setAttribute("data-blapy-template-default-id",i.templateId)})}let l=a.method;l||(l="POST"),i=Object.assign(i,{blapycall:"1",blapyaction:i.blapyaction,blapyobjectid:n});const s={method:l};"GET"===l.toUpperCase()?s.params=i:s.body=i,this.opts.theBlapy.ajaxService.request(r,s).then(t=>{t&&("object"==typeof t&&(t=JSON.stringify(t)),o&&(t=this.opts.theBlapy.embedHTMLPage(t,o)),this.trigger("pageLoaded",{htmlPage:t,params:i}))}).catch(t=>{this.trigger("errorOnLoadingPage",r+": "+t.message)})},next_state:"ProcessPageChange"},updateBlock:{init_function:function(t,e,a){this.opts.beforePageLoad&&this.opts.beforePageLoad(a),this.opts.theBlapy.trigger("Blapy_beforePageLoad",a),a?.html||(this.opts.theBlapy.logger.info("updateBlock: no html property found"),this.trigger("errorOnLoadingPage","updateBlock: no html property found"))},out_function:function(t,e,a){if(!a)return;a.params||(a.params={}),"embeddingBlockId"in a.params&&!a.params.embeddingBlockId&&this.opts.theBlapy.logger.info(`[updateBlock on ${this.myUIObjectID} embeddingBlockId has been set but is undefined! must be an error...]`);let r=a.params.embeddingBlockId;if("object"==typeof a.html&&(a.html=JSON.stringify(a.html)),r&&a.params.templateId){const t=this.myUIObject.querySelector(`[data-blapy-container-name='${r}']`);t&&t.setAttribute("data-blapy-template-default-id",a.params.templateId)}r&&(a.html=this.opts.theBlapy.embedHTMLPage(a.html,r)),this.trigger("pageLoaded",{htmlPage:a.html,params:a.params})},next_state:"ProcessPageChange"},reloadBlock:{init_function:function(t,e,a){let r={};a&&(r=a.params),"embeddingBlockId"in r&&!r.embeddingBlockId&&this.opts.theBlapy.logger.info("[reloadBlock on "+this.myUIObjectID+"] embeddingBlockId has been set but is undefined! must be an error...",1),this.opts.theBlapy.setBlapyJsonTemplates(!0,r.embeddingBlockId,r.templateId),this.opts.theBlapy.setBlapyUpdateOnDisplay()}}},ProcessPageChange:{enterState:{},pageLoaded:{init_function:function(t,e,a){let r=a.htmlPage,n=a.params,i=n.blapyobjectid,o=this,l=null,s="undefined"!=typeof JSON5?JSON5:JSON;try{if(l=s.parse(r),r=l,r instanceof Array){let t=$(""),e="";for(const a of r)e=this.opts.theBlapy.createBlapyBlock(a),t=t.add(e);r=t}else"object"==typeof r?r=this.opts.theBlapy.createBlapyBlock(r):o.opts.theBlapy.logger.info("downloaded content is not html neither json object, that's curious... "+r+" - "+containerName,1)}catch(p){}n.blapyaction,this.myUIObject[0].querySelectorAll("[data-blapy-container]").forEach(async t=>{let e=t,a=e.getAttribute("data-blapy-container-name");n["force-update"]||(n["force-update"]=0);let l=null;try{l=$(r).filter('[data-blapy-container-name="'+a+'"]').add($(r).find('[data-blapy-container-name="'+a+'"]')).first()}catch(p){return void this.opts.theBlapy.logger.error(p)}if(!l||0===l.length)return;if(null!=l.attr("data-blapy-applyon")){let t=l.attr("data-blapy-applyon").split(",");if(t.length>0&&-1==$.inArray(i,t))return}l=l.get(0),e.id||o.opts.theBlapy.logger.warn("A blapy block has no id: "+e.outerHTML.substring(0,250)),l.id||(l.id=e.id);let c=l.getAttribute("data-blapy-update"),d=!1;("local"===e.getAttribute("data-blapy-update-rule")||"json"===c&&"json"!==e.getAttribute("data-blapy-update"))&&(c=e.getAttribute("data-blapy-update"),d=!0);let g=l.querySelector("xmp.blapybin");if("json"!==c&&g&&(l.innerHTML=this.opts.theBlapy.utils.atou(g.innerHTML)),o.opts.beforeContentChange&&o.opts.beforeContentChange(e),e.dispatchEvent(new CustomEvent("Blapy_beforeContentChange",{detail:this.myUIObject})),c&&"update"!==c)if("force-update"===c)d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("append"===c)l.insertAdjacentHTML("afterbegin",e.innerHTML),d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("prepend"===c)l.insertAdjacentHTML("beforeend",e.innerHTML),d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l;else if("json-append"===c){let t=e.getAttribute("data-blapy-json-data"),a=[];if(t)try{a=s.parse(t),Array.isArray(a)||(a=[a])}catch(p){o.opts.theBlapy.logger.warn("Could not parse existing JSON data, starting fresh","json-append"),a=[]}let r=null;if(g)try{const t=g.innerHTML,e=o.opts.theBlapy.utils.atou(t);r=s.parse(e)}catch(p){return void o.opts.theBlapy.logger.error("Failed to decode/parse new JSON data","json-append")}else try{const t=l.innerHTML;r=s.parse(t)}catch(p){return void o.opts.theBlapy.logger.error("Failed to parse new JSON data","json-append")}r&&r["blapy-data"]&&(r=r["blapy-data"]);let n=[];const i=e.getAttribute("data-blapy-json-append-strategy")||"end";if("start"===i)n=Array.isArray(r)?[...r,...a]:[r,...a];else if("unique"===i){const t=e.getAttribute("data-blapy-json-unique-key")||"id";n=[...a];const i=Array.isArray(r)?r:[r];for(const e of i){n.some(a=>a[t]&&e[t]&&a[t]===e[t])||n.push(e)}}else n=Array.isArray(r)?[...a,...r]:[...a,r];const c=parseInt(e.getAttribute("data-blapy-json-max-items"));c&&c>0&&n.length>c&&(n="start"===i?n.slice(0,c):n.slice(-c)),e.setAttribute("data-blapy-json-data",JSON.stringify(n));const d=l.cloneNode(!0);d.innerHTML=JSON.stringify(n),await o.opts.theBlapy.templateManager.processJsonUpdate(null,e,d,s,o.opts.theBlapy),e.dispatchEvent(new CustomEvent("Blapy_jsonAppended",{detail:{newItems:Array.isArray(r)?r.length:1,totalItems:n.length,data:n}})),o.opts.theBlapy.logger.info(`JSON Append completed: added ${Array.isArray(r)?r.length:1} items, total: ${n.length}`,"json-append")}else if("replace"===c)e.innerHTML=l.innerHTML,e=l;else if("custom"===c)l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=n["force-update"]||(o.opts.doCustomChange&&o.opts.doCustomChange(e,l),e.dispatchEvent(new CustomEvent("Blapy_doCustomChange",{detail:l})));else if("remove"===c){let t=e.parentNode;e.remove(),e=t}else if("json"===c)await o.opts.theBlapy.templateManager.processJsonUpdate(g,e,l,s,this.opts.theBlapy);else{let t=o.opts.theBlapy.animation[c];t&&"function"==typeof t?l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=n["force-update"]&&"true"!==l.getAttribute("data-blapy-container-force-update")||t(e,l):o.opts.theBlapy.logger.error(`${c} does not exist`)}else l.getAttribute("data-blapy-container-content")===e.getAttribute("data-blapy-container-content")&&1!=n["force-update"]||(d?e.innerHTML=l.innerHTML:e.outerHTML=l.outerHTML,e=l);if(o.opts.theBlapy.blapyBlocks.setBlapyUpdateIntervals(),o.opts.theBlapy.setBlapyUpdateOnDisplay(),o.opts.theBlapy.setBlapyURL(),o.opts.afterContentChange&&o.opts.afterContentChange(e),e.id){let t=document.getElementById(e.id);t&&t.dispatchEvent(new CustomEvent("Blapy_afterContentChange",{detail:e}))}})},out_function:function(t,e,a){this.opts.afterPageChange&&this.opts.afterPageChange(),this.opts.theBlapy.trigger("Blapy_afterPageChange",a)},next_state:"PageReady"},errorOnLoadingPage:{init_function:function(t,e,a){this.opts.onErrorOnPageChange&&this.opts.onErrorOnPageChange(a),this.opts.theBlapy.trigger("Blapy_ErrorOnPageChange",[a])},next_state:"PageReady"},reloadBlock:"loadUrl",updateBlock:"loadUrl",postData:"loadUrl",loadUrl:{how_process_event:{delay:50,preventcancel:!0},propagate_event:!0}},DefaultState:{start:{next_state:"PageLoaded"}}};return this.opts.fsmExtension&&this._deepMerge(t,this.opts.fsmExtension),$(this.myUIObject).iFSM(t,this.optsIfsm),this.myFSM=$(this.myUIObject).getFSM(t),!!this.router.init()||(this.logger.error("Failed to initialize router","core"),!1)}catch(t){return this.logger.error(`Failed to initialize application: ${t.message}`,"core"),!1}}trigger(t,e=null){this.logger.info(`[Sending event] ${t} - Diffused`);const a=new CustomEvent(t,{detail:e,bubbles:!0});this.myUIObject.dispatchEvent(a)}setBlapyURL(){this.logger.info("Set blapyURL","router");this.container.querySelectorAll("[data-blapy-link]").forEach(t=>{if(this._shouldSkipLink(t))return;let e=this._getHref(t);e&&(e=this._normalizeHref(e,t),this._updateHref(t,e))})}_shouldSkipLink(t){const e=t.getAttribute("data-blapy-active-blapyId");return e&&e!==this.myUIObjectID}_getHref(t){switch(t.tagName){case"A":return t.getAttribute("href");case"FORM":return t.getAttribute("action");default:return t.getAttribute("data-blapy-href")}}_normalizeHref(t,e){if(!t.includes("#blapylink")){t+="#blapylink";const a=e.getAttribute("data-blapy-embedding-blockid");a&&(t+=`#${a}`)}if("A"!==e.tagName&&"FORM"!==e.tagName&&!t.startsWith("/")&&!/^https?:\/\//i.test(t)){const e=document.querySelector("base")?.getAttribute("href");t=e?e+t:window.location.pathname.replace(/[^/]*$/,"")+t}return t}_updateHref(t,e){switch(t.tagName){case"A":t.setAttribute("href",e);break;case"FORM":t.setAttribute("action",e);break;default:t.setAttribute("data-blapy-href",e),t.addEventListener("click",()=>{this.myFSM.trigger("loadUrl",{aUrl:e,params:{},aObjectId:this.myUIObjectID})})}}navigate(t,e={}){this.opts.enableRouter&&this.router.isInitialized?this.router.navigate(t,e):this.myFSM.trigger("loadUrl",{aUrl:t,params:e.params||{},aObjectId:this.myUIObjectID,noBlapyData:e.noBlapyData})}embedHTMLPage(t,e){this.logger.info("embedHTML","core");const a=this.myUIObject.querySelector("[data-blapy-container-name='"+e+"']");if(!a)return this.logger.error(`embedHtmlPage: Error on blapy-container-name... ${e} does not exist!`),"";if("json"===a.getAttribute("data-blapy-update")&&"0"===a.getAttribute("data-blapy-template-init-purejson"))try{t instanceof Element&&(t=t.innerHTML)}catch(l){this.logger.warn(`embedHtmlPage: aHtmlSource is perhaps a pure json after all...?\n${t.toString()} ${l}`)}const r='<xmp class="blapybin">'+this.utils.utoa(t)+"</xmp>",n=document.createElement("div");n.innerHTML=a.outerHTML;const i=n.firstElementChild;i.innerHTML=r;const o=i.getAttribute("data-blapy-container-content")||"";return i.setAttribute("data-blapy-container-content",o+"-"+Date.now()),i.removeAttribute("id"),i.outerHTML}async setBlapyJsonTemplates(t,e,a){if(this.logger.info("setBlapyJsonTemplates","core"),null==t&&(t=!1),e=e?`[data-blapy-container-name='${e}']`:"",a){const t='[data-blapy-update="json"]'+e;this.container.querySelectorAll(t).forEach(t=>{t.setAttribute("data-blapy-template-default-id",a)})}let r=this.container.querySelectorAll('[data-blapy-update="json"]'+e);if(r.length>0){for(const e of r)await this.templateManager.setBlapyContainerJsonTemplate(e,this,t);this.myFSM.trigger("blapyJsonTemplatesIsSet")}else this.myFSM.trigger("blapyJsonTemplatesIsSet")}async setBlapyUpdateOnDisplay(){this.logger.info("setBlapyUpdateOnDisplay","core");const t=this.myUIObject.querySelectorAll("[data-blapy-updateblock-ondisplay]");if(0===t.length)return;if(!("IntersectionObserver"in window))return void alert("Blapy: IntersectionObserver is not supported. Need it to process data-blapy-updateblock-ondisplay option");const e=this,a=new IntersectionObserver((t,a)=>{t.forEach(t=>{if(t.isIntersecting){const r=t.target;if(!r.hasAttribute("data-blapy-appear"))if(r.setAttribute("data-blapy-appear","done"),this.logger.info(`Element became visible: ${r.getAttribute("data-blapy-container-name")}`,"setBlapyUpdateOnDisplay"),r.hasAttribute("data-blapy-href"))e.myFSM.trigger("loadUrl",{aUrl:r.getAttribute("data-blapy-href"),params:{},aObjectId:e.myUIObjectID,noBlapyData:r.getAttribute("data-blapy-noblapydata")});else if(r.hasAttribute("data-blapy-template-init")){const t=r.getAttribute("data-blapy-container-name");e.myFSM.trigger("reloadBlock",{params:{embeddingBlockId:t}})}a.unobserve(r)}})},{root:null,rootMargin:"0px",threshold:.1});t.forEach(t=>{this.logger.info(`Observing element: ${t.getAttribute("data-blapy-container-name")}`,"setBlapyUpdateOnDisplay"),a.observe(t)})}createBlapyBlock(t){return t["blapy-container-name"]||this._log("createBlapyBlock: Error on received json where blapy-container-name is not defined!\nPerhaps it's pure json not defined as such in Blapy block configuration (cf. data-blapy-template-init-purejson)...\n"+JSON.stringify(t),1),$("<div/>",{"data-blapy-container":!0,"data-blapy-container-name":t["blapy-container-name"],"data-blapy-container-content":t["blapy-container-content"],"data-blapy-update":"json"}).html(JSON.stringify(t["blapy-data"]))}_deepMerge(t,e){for(const a in e)e.hasOwnProperty(a)&&"object"==typeof e[a]&&null!==e[a]&&!Array.isArray(e[a])?(t[a]&&"object"==typeof t[a]||(t[a]={}),this._deepMerge(t[a],e[a])):t[a]=e[a];return t}}function createBlapy(t,e={}){return document.querySelector(t).Blapy(e)}HTMLElement.prototype.Blapy=function(t={}){if(this._blapyInstance)return this._blapyInstance;const e=new Blapy(this,t);return e.initApplication(),this._blapyInstance=e,e},window.Blapy2={Blapy:Blapy,createBlapy:createBlapy,Logger:Logger,Utils:Utils,AjaxService:AjaxService,TemplateManager:TemplateManager,Router:Router,BlapyBlock:BlapyBlock}})();
